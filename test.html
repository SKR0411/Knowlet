<!DOCTYPE html>
<html>
<head>
    <title>Public Avatar Upload</title>
</head>
<body>

<img id="avatar" width="120" />
<br><br>

<input type="file" id="input-image" accept="image/png,image/jpeg">
<button id="upload-btn">Upload</button>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://ampwczxrfpbqlkuawrdf.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcHdjenhyZnBicWxrdWF3cmRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTk4MzYsImV4cCI6MjA3ODM3NTgzNn0.hFib9Y5x02b5VWjKuNi1XkUYvycmrp0DQhnwNkOGJEU";

const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
);

document.getElementById("upload-btn").addEventListener("click", uploadAvatar);

async function uploadAvatar() {
    const originalFile = document.getElementById("input-image").files[0];

    if (!originalFile) {
        alert("Select an image first");
        return;
    }
    
    if (!originalFile.type.startsWith("image/")) {
        alert("Only images allowed");
        return;
    }
    
    if (originalFile.size > 5 * 1024 * 1024) {
        alert("Image too large");
        return;
    }
    
    const compressedFile = await compressWithCanvas(
        originalFile,
        0.7,   // quality
        512    // max width/height
    );
    
    const fileExt = compressedFile.name.split('.').pop();
    const fileName = `avatar-${Date.now()}.${fileExt}`;
    const filePath = `public/${fileName}`;

    const { error } = await supabaseClient.storage
        .from("avatars")
        .upload(filePath, compressedFile, {
            cacheControl: "3600",
            upsert: false
        });

    if (error) {
        console.error(error);
        alert(error.message);
        return;
    }

    const { data } = supabaseClient.storage
        .from("avatars")
        .getPublicUrl(filePath);

    document.getElementById("avatar").src = data.publicUrl;
}

function compressWithCanvas(file, quality = 0.7, maxSize = 512) {
    return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = e => {
            img.src = e.target.result;
        };

        img.onload = () => {
            const canvas = document.createElement("canvas");
            const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);

            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                resolve(new File([blob], file.name, { type: "image/jpeg" }));
            }, "image/jpeg", quality);
        };

        reader.readAsDataURL(file);
    });
}

</script>

</body>
</html>