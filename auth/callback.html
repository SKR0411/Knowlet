<!DOCTYPE html>
<html>
<head>
    <title>Supabase OAuth Callback</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h2 id="title">Processing login…</h2>
    <pre id="msg"></pre>

    <script>
        // Supabase config
        const SUPABASE_URL = "https://ampwczxrfpbqlkuawrdf.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcHdjenhyZnBicWxrdWF3cmRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTk4MzYsImV4cCI6MjA3ODM3NTgzNn0.hFib9Y5x02b5VWjKuNi1XkUYvycmrp0DQhnwNkOGJEU";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const title = document.getElementById("title");
        const msg = document.getElementById("msg");

        async function handleCallback() {
            try {
                // Log URL hash for debugging (never affects UI)
                console.log("URL Hash:", window.location.hash);

                // If URL does not contain an OAuth hash, avoid errors
                if (!window.location.hash.includes("access_token")) {
                    title.textContent = "Invalid OAuth Redirect ❌";
                    msg.textContent = "No OAuth data found in URL. This page must be opened after Google login.";
                    return;
                }

                // Process redirect and store session
                const { data, error } = await supabase.auth.getSessionFromUrl({
                    storeSession: true
                });

                if (error) {
                    title.textContent = "Authentication Failed ❌";
                    msg.textContent = error.message;
                    console.error("OAuth Error:", error);
                    return;
                }

                // Extract session
                const session = data.session;

                if (!session) {
                    title.textContent = "No Session Found ❌";
                    msg.textContent = "Supabase returned no session.";
                    return;
                }

                title.textContent = "Login Successful! ✅";
                msg.textContent = JSON.stringify(session, null, 2);
                console.log("User logged in:", session.user);

                // Optional redirect
                // window.location.href = "/dashboard.html";

            } catch (err) {
                title.textContent = "Unexpected Error ❌";
                msg.textContent = err.message || "Unknown error";
                console.error("Unexpected Error:", err);
            }
        }

        handleCallback();
    </script>
</body>
</html>